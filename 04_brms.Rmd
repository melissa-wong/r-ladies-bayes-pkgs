---
output:
  html_document: default
  pdf_document: default
---
# brms {#brms}

## Resources

- [Overview of brms](https://cran.r-project.org/web/packages/brms/vignettes/brms_overview.pdf)

- [Solomon Kurz's translation of _Statistical Rethinking_](https://bookdown.org/content/4857/)

## Description


## Environment Setup

```{r setup, results="hide", message=FALSE}

set.seed(123)
options("scipen" = 1, "digits" = 4)
knitr::opts_chunk$set(message=FALSE)

library(tidyverse)
library(datasets)
data(mtcars)

library(brms)
library(bayesplot)


# Set number of cores
options(mc.cores = parallel::detectCores())
```

## Linear Model

### Define Model

The `brms` package default priors are improper flat priors over the real line. However, there is a strong case to be made against this type of non-informative prior ^[https://mc-stan.org/users/documentation/case-studies/weakly_informative_shapes.html]. So I'll proceed directly to specifying priors based on the EPA data.

\begin{align*}
  mpg &\sim Normal(\mu, \sigma^2) \\
  \mu &= a + b*disp \\
  a &\sim Normal(13.2, 5.3^2) \\
  b &\sim Normal(-0.1, 0.05^2) \\
  \sigma &\sim Exponential(1)
\end{align*}

```{r mdl1, results="hide"}

mdl1 <- brm(mpg ~ disp, data=mtcars, family=gaussian(), 
            prior=c(set_prior("normal(-0.1, 0.05)", class="b", coef = "disp"),
                    set_prior("normal(13.2, 5.3)", class="Intercept")))

```

```{r mdl1_stancode}
stancode(mdl1)
```


### Prior Predictive Distribution

```{r mdl1_prior, results="hide"}
D <- seq(min(mtcars$disp), max(mtcars$disp))

mdl1_prior <- brm(mpg ~ disp, data=mtcars, family=gaussian(), 
            prior=c(set_prior("normal(-0.1, 0.05)", class="b", coef = "disp"),
                    set_prior("normal(13.2, 5.3)", class="Intercept")),
            sample_prior="only")

# Samples from posterior predictive distribution
ppd <- as.data.frame(predict(mdl1_prior, newdata=data.frame(disp=D)))
# Samples from expected value of posterior predictive distribution
eppd <- posterior_epred(mdl1_prior, newdata=data.frame(disp=D), summary=FALSE) %>%
  head(50) %>%
  t() %>%
  as.data.frame() %>%
  mutate(disp=D) %>%
  pivot_longer(-disp, names_to="iter", values_to="mpg")


ggplot() +
  geom_ribbon(data=ppd, mapping=aes(x=D, ymin=Q2.5, ymax=Q97.5), alpha=0.5, fill="lightblue") +
  geom_line(data=eppd, mapping=aes(x=disp, y=mpg, group=iter), alpha=0.2) 
```


### Diagnostics

```{r mdl1_trankplot}
mcmc_rank_overlay(mdl1, pars=c("b_Intercept", "b_disp", "sigma"))
```

```{r mdl1_summary}
summary(mdl1)
```

### Posterior Distribution

```{r mdl1_post}
fixef(mdl1)
```

### Posterior Predictive Distribution

```{r mdl1_ppd, results="hide"}

D <- seq(min(mtcars$disp), max(mtcars$disp))

# Samples from posterior predictive distribution
ppd <- as.data.frame(predict(mdl1, newdata=data.frame(disp=D)))
# Samples from expected value of posterior predictive distribution
eppd <- posterior_epred(mdl1, newdata=data.frame(disp=D), summary=FALSE) %>%
  head(50) %>%
  t() %>%
  as.data.frame() %>%
  mutate(disp=D) %>%
  pivot_longer(-disp, names_to="iter", values_to="mpg")


ggplot() +
  geom_ribbon(data=ppd, mapping=aes(x=D, ymin=Q2.5, ymax=Q97.5), alpha=0.5, fill="lightblue") +
  geom_line(data=eppd, mapping=aes(x=disp, y=mpg, group=iter), alpha=0.2) +
  geom_point(data=mtcars, mapping=aes(x=disp, y=mpg))
```

## Semi-parametric Model

### Define Model

First, I'll define the splines just as I did with the `rethinking` package.  

```{r splines}
library(splines)

num_knots <- 4  # number of interior knots
knot_list <- quantile(mtcars$disp, probs=seq(0,1,length.out = num_knots))
B <- bs(mtcars$disp, knots=knot_list[-c(1,num_knots)], intercept=TRUE)

df1 <- cbind(disp=mtcars$disp, B) %>%
  as.data.frame() %>%
  pivot_longer(-disp, names_to="spline", values_to="val")

# Plot at smaller intervals so curves are smooth
N<- 50
D <- seq(min(mtcars$disp), max(mtcars$disp), length.out = N)
B_plot <- bs(D, 
             knots=knot_list[-c(1,num_knots)], 
             intercept=TRUE)

df2 <- cbind(disp=D, B_plot) %>%
  as.data.frame() %>%
  pivot_longer(-disp, names_to="spline", values_to="val")

ggplot(mapping=aes(x=disp, y=val, color=spline)) +
  geom_point(data=df1) +
  geom_line(data=df2, linetype="dashed")
```

Note: the dashed lines are the splines and the points are the values of the spline at the specific values of `mtcars$disp`; the points are inputs into the `stan` model.



### Prior Predictive Distribution



### Diagnostics



### Posterior Distribution



### Posterior Predictive Distribution



## Semi-parametric Model (Random Walk Prior)

### Define Model

### Prior Predictive Distribution

### Diagnostics

### Posterior Distribution

### Posterior Predictive Distribution


## Session Info

```{r}
sessionInfo()
```

